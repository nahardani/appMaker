<!DOCTYPE html>
<html lang="fa" dir="rtl" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Ú¯Ø§Ù… Û´ â€” Ú©Ù†ØªØ±Ù„Ø± / Endpoint</title>
    <link rel="stylesheet" th:href="@{/css/style.css}"/>
    <link rel="stylesheet" th:href="@{/css/wizard-controllers.css}"/>
</head>
<body>
<th:block th:replace="fragments/_header :: topbar(title=' Ú©Ù†ØªØ±Ù„Ø±', project=${project})"></th:block>



<div class="container">
    <div class="layout">
        <!-- Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± Ú©Ù†ØªØ±Ù„Ø±Ù‡Ø§ -->
        <aside class="side" th:replace="~{fragments/_sidebar-controllers :: sidebar(project=${project})}"></aside>

        <!-- Ø³ØªÙˆÙ† Ø±Ø§Ø³Øª -->
        <main class="main">

            <!-- Ù‡ÛŒØ¯Ù†â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ù†ØªÚ©Ø³Øª Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡â€ŒÛŒ JS -->
            <input type="hidden" id="ctxProjectId" th:value="${project.id}">
            <input type="hidden" id="ctxCtrlName"  th:value="${selectedCtrl != null ? selectedCtrl.name : ''}">

            <!-- Ù†ÙˆØ§Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ù†Ø¯Ù¾ÙˆÛŒÙ†ØªÙ Ú©Ù†ØªØ±Ù„Ø± Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ -->
            <div class="card">
                <div class="card-head">
                    <h3>
                        Ú©Ù†ØªØ±Ù„Ø±:
                        <span class="tag" th:text="${selectedCtrl != null ? selectedCtrl.name : 'â€”'}">â€”</span>
                    </h3>

                    <div style="margin-inline-start:auto; display:flex; gap:8px; align-items:center">
                        <label for="endpointSelect">Ø§Ù†Ø¯Ù¾ÙˆÛŒÙ†Øª:</label>
                        <select id="endpointSelect">
                            <option value="">â€” Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ù†Ø¯Ù¾ÙˆÛŒÙ†Øª â€”</option>
                            <option th:each="e : ${selectedCtrl != null && selectedCtrl.endpoints != null ? selectedCtrl.endpoints : {}}"
                                    th:value="${e.name}"
                                    th:text="${e.name + ' â€” [' + e.httpMethod + '] /' + e.path}"
                                    th:selected="${selectedEp != null and selectedEp.name == e.name}">
                            </option>
                        </select>

                        <!-- Ø¯Ú©Ù…Ù‡Ù” Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù†Ø¯Ù¾ÙˆÛŒÙ†Øªâ€ŒÙ‡Ø§ (Ù…ÙˆØ¯Ø§Ù„) -->
                        <button type="button"
                                class="icon-btn"
                                title="Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù†Ø¯Ù¾ÙˆÛŒÙ†Øªâ€ŒÙ‡Ø§"
                                th:attr="data-project-id=${project.id}, data-ctrl-name=${selectedCtrl != null ? selectedCtrl.name : ''}"
                                onclick="openEpModal(this.dataset.projectId, this.dataset.ctrlName)">
                            ğŸ“
                        </button>
                    </div>
                </div>
            </div>

            <!-- Ø§Ú¯Ø± ep ÙØ§ÛŒÙ„ AI Ø¯Ø§Ø±Ø¯: Ø§Ø¨ØªØ¯Ø§ committedØŒ Ø¨Ø¹Ø¯ Ø¨Ø§Ú©Ø³ AI Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²ØªÙˆÙ„ÛŒØ¯/Ø¨Ù‡Ø¨ÙˆØ¯ -->
            <div th:if="${selectedEp != null and selectedEp.aiFiles != null and !#lists.isEmpty(selectedEp.aiFiles)}" style="margin-top:12px">
                <!-- 1) ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡ -->
                <section th:replace="~{fragments/_ai-committed :: committed(project=${project}, ctrl=${selectedCtrl}, ep=${selectedEp})}"></section>

                <!-- 2) Ø¨Ø§Ú©Ø³ AI Ø¨Ø±Ø§ÛŒ Â«Ø¨Ø§Ø²â€ŒØªÙˆÙ„ÛŒØ¯/Ø¨Ù‡Ø¨ÙˆØ¯Â» -->
                <details class="card" style="margin-top:12px;">
                    <summary style="cursor:pointer;">Ù†Ù…Ø§ÛŒØ´/Ù…Ø®ÙÛŒâ€ŒÚ©Ø±Ø¯Ù† Ø¨Ø§Ú©Ø³ AI (Ø¨Ø§Ø²â€ŒØªÙˆÙ„ÛŒØ¯/Ø¨Ù‡Ø¨ÙˆØ¯)</summary>
                    <div style="margin-top:8px">
                        <section th:replace="~{fragments/_ai-box :: aiBox(project=${project}, ctrl=${selectedCtrl}, ep=${selectedEp}, mode='REFINE')}"></section>
                    </div>
                </details>
            </div>




            <!-- Ø§Ú¯Ø± Ø§Ù†Ø¯Ù¾ÙˆÛŒÙ†Øª Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ ÙØ§ÛŒÙ„ AI Ù†Ø¯Ø§Ø±Ø¯ (ÛŒØ§ Ø§ØµÙ„Ø§Ù‹ Ø§Ù†Ø¯Ù¾ÙˆÛŒÙ†ØªÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡): ai-box Ø±Ø§ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡ -->
            <div th:if="${selectedEp == null or selectedEp.aiFiles == null or #lists.isEmpty(selectedEp.aiFiles)}" style="margin-top:12px">
                <section th:replace="~{fragments/_ai-box :: aiBox(project=${project}, ctrl=${selectedCtrl}, ep=${selectedEp}, mode='NEW')}"></section>
            </div>

            <!-- Ù†Ø§ÙˆØ¨Ø±ÛŒ Ù¾Ø§ÛŒÛŒÙ† ØµÙØ­Ù‡ -->
            <div class="card" style="margin-top:12px;">
                <div class="actions" style="justify-content:flex-end; gap:8px;">
                    <a class="btn btn-secondary" th:href="@{'/wizard/' + ${project.id} + '/packages'}">â† Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ú¯Ø§Ù… Ù¾Ú©ÛŒØ¬â€ŒÙ‡Ø§</a>
                    <a class="btn btn-primary"    th:href="@{'/wizard/' + ${project.id} + '/final'}">Ø§Ø¯Ø§Ù…Ù‡ â†’ Ú¯Ø§Ù… Ù†Ù‡Ø§ÛŒÛŒ</a>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§ÛŒ Ù¾Ù†Ù‡Ø§Ù† Ùˆ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù†Ø¯Ù¾ÙˆÛŒÙ†Øª -->
<th:block th:replace="~{fragments/_templates-hidden :: hiddenTemplates}"></th:block>
<th:block th:replace="~{fragments/_endpoint-modal :: endpointModal}"></th:block>



<!-- Ø§Ø³Ú©Ø±ÛŒÙ¾Øªâ€ŒÙ‡Ø§ -->
<script th:src="@{/js/wizard-controllers.js?v=14}"></script>
<script>
    // Ø³Ø§Ø®Øª Ú©Ù†ØªØ±Ù„Ø± Ø¬Ø¯ÛŒØ¯ Ø§Ø² Ø³Ø§ÛŒØ¯Ø¨Ø§Ø±
    function createNewController(projectId) {
        const name = prompt('Ù†Ø§Ù… Ú©Ù†ØªØ±Ù„Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ù„: OrderController):');
        if (!name) return;
        location.href = `/wizard/${encodeURIComponent(projectId)}/controllers?ctrl=${encodeURIComponent(name)}`;
    }

    // ÙˆØµÙ„ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ Â«Ú©Ù†ØªØ±Ù„Ø± Ø¬Ø¯ÛŒØ¯ +Â» Ø¯Ø± Ø³Ø§ÛŒØ¯Ø¨Ø§Ø±
    document.addEventListener('DOMContentLoaded', () => {
        const btn = document.querySelector('[data-action="new-controller"]');
        if (btn && !btn._wired) {
            btn._wired = true;
            const pid = btn.getAttribute('data-project-id');
            btn.addEventListener('click', () => createNewController(pid));
        }
    });

    // ØªØºÛŒÛŒØ± Ø§Ù†Ø¯Ù¾ÙˆÛŒÙ†Øª => Ø±ÙØ±Ø´ Ø¨Ø§ ctrl Ùˆ ep Ø¬Ø¯ÛŒØ¯
    (function () {
        const sel  = document.getElementById('endpointSelect');
        const pid  = document.getElementById('ctxProjectId')?.value || '';
        const ctrl = document.getElementById('ctxCtrlName')?.value   || '';

        if (!sel) return;

        sel.addEventListener('change', () => {
            if (!pid || !ctrl) return;
            const ep = sel.value || '';
            const url = ep
                ? `/wizard/${encodeURIComponent(pid)}/controllers?ctrl=${encodeURIComponent(ctrl)}&ep=${encodeURIComponent(ep)}`
                : `/wizard/${encodeURIComponent(pid)}/controllers?ctrl=${encodeURIComponent(ctrl)}`;
            location.href = url;
        });
    })();

    // âœ… Ø³Ø±Ø§Ø³Ø±ÛŒ: Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¯Ø§Ù„ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ù…Ø¬Ø¯Ø¯ Generate Ø¨Ø§ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§
    window.showPreflightQuestions = function(questions, prevPayload){
        const $modal = document.getElementById('preflight-modal');
        const $form  = document.getElementById('preflight-form');
        const $list  = document.getElementById('preflight-questions');
        const $close = document.getElementById('preflight-close');
        const $cancel= document.getElementById('preflight-cancel');

        // Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ù‚Ø¨Ù„ÛŒ
        $list.innerHTML = '';

        // Ø±Ù†Ø¯Ø± Ù‡Ø± Ø³Ø¤Ø§Ù„
        (questions || []).forEach(q => {
            // q: { key, label, type: 'text'|'select', required, placeholder, options? }
            const wrap = document.createElement('div');
            wrap.style.marginBottom = '12px';

            const label = document.createElement('label');
            label.style.display = 'block';
            label.style.marginBottom = '6px';
            label.style.fontSize = '13px';
            label.style.color = '#94a3b8';
            label.textContent = q.label || q.key;
            label.setAttribute('for', `q-${q.key}`);

            let input;
            if (q.type === 'select' && Array.isArray(q.options)) {
                input = document.createElement('select');
                input.style.width = '100%';
                input.style.padding = '8px';
                input.style.borderRadius = '8px';
                input.style.border = '1px solid #334155';
                input.style.background = '#0b1220';
                input.style.color = '#e2e8f0';
                input.id = `q-${q.key}`;
                q.options.forEach(opt => {
                    const o = document.createElement('option');
                    o.value = opt; o.textContent = opt;
                    input.appendChild(o);
                });
            } else {
                input = document.createElement('input');
                input.type = 'text';
                input.style.width = '100%';
                input.style.padding = '8px';
                input.style.borderRadius = '8px';
                input.style.border = '1px solid #334155';
                input.style.background = '#0b1220';
                input.style.color = '#e2e8f0';
                input.id = `q-${q.key}`;
                if (q.placeholder) input.placeholder = q.placeholder;
            }
            if (q.required) input.required = true;

            // Ù…Ù‚Ø¯Ø§Ø± Ù‚Ø¨Ù„ÛŒ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯
            if (prevPayload && prevPayload[q.key] != null) input.value = prevPayload[q.key];

            wrap.appendChild(label);
            wrap.appendChild(input);
            $list.appendChild(wrap);
        });

        // Ù†Ù…Ø§ÛŒØ´
        $modal.style.display = 'block';

        const closeModal = () => { $modal.style.display = 'none'; };
        $close.onclick = closeModal;
        $cancel.onclick = closeModal;

        // Submit: Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ù…Ø¬Ø¯Ø¯
        $form.onsubmit = async (e) => {
            e.preventDefault();

            const answers = {};
            (questions || []).forEach(q => {
                const el = document.getElementById(`q-${q.key}`);
                answers[q.key] = el ? el.value : null;
            });

            const merged = { ...(prevPayload || {}), ...(answers || {}) };
            // Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ ÙˆÙ‚ØªÛŒ Ù¾Ø±Ø³Ø´â€ŒÙ‡Ø§ Ù…Ø·Ø±Ø­ Ø´Ø¯Ù‡ ÛŒØ¹Ù†ÛŒ needsExternal=true
            if (questions.some(q => String(q.key).toLowerCase().startsWith('external'))) {
                merged.needsExternal = true;
            }

            closeModal();

            // ØµØ¯Ø§ Ø²Ø¯Ù† ØªØ§Ø¨Ø¹ Ø³Ø±Ø§Ø³Ø±ÛŒ Ú©Ù‡ Ø¯Ø± fragment ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡ Ø§Ø³Øª
            if (typeof window.aiGenerate === 'function') {
                // ÛŒÚ© Ù¾ÛŒØ§Ù… Ú©ÙˆÚ†Ú© ÙˆØ¶Ø¹ÛŒØª
                const st = document.getElementById('aiStatus');
                if (st){ st.style.display='block'; st.textContent='ØªÚ©Ù…ÛŒÙ„ ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§â€¦ ØªÙˆÙ„ÛŒØ¯ Ù…Ø¬Ø¯Ø¯ Ú©Ø¯ ØªÙˆØ³Ø· AIâ€¦'; }
                // Ø¯Ú©Ù…Ù‡ ØªÙˆÙ„ÛŒØ¯ disable
                const btnGen = document.getElementById('btnGen'); if (btnGen) btnGen.disabled = true;

                await window.aiGenerate(merged);

                if (btnGen) btnGen.disabled = false;
            } else {
                alert('Generate function not found!');
            }
        };
    };
</script>
</body>
</html>

