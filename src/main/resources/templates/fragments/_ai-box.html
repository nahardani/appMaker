<!-- fragments/_ai-box.html -->
<div th:fragment="aiBox(project, ctrl, ep, mode)">
    <div class="card">
        <div class="card-head">
            <h3 th:text="${mode == 'REFINE' ? 'Ø¨Ø§Ø²â€ŒØªÙˆÙ„ÛŒØ¯/Ø¨Ù‡Ø¨ÙˆØ¯ Ø¨Ø§ AI' : 'ØªÙˆÙ„ÛŒØ¯ Ú©Ø¯ Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ'}">AI</h3>
            <small class="muted" style="margin-inline-start:auto">
                Java:
                <span th:text="${project.ms != null ? project.ms.javaVersion : project.javaVersion}">17</span>
                â€¢ Base package:
                <span th:text="${project.ms != null ? project.ms.basePackage : ''}">com.example.app</span>
                â€¢ Ctl:
                <code th:text="${ctrl != null ? ctrl.name : 'â€”'}">â€”</code>
                â€¢ Ep:
                <code th:text="${ep != null ? ep.name : 'â€”'}">â€”</code>
            </small>
        </div>

        <form id="aiForm" onsubmit="return doGenerate(event)">
            <!-- hidden context -->
            <input type="hidden" id="projectId"  th:value="${project.id}"/>
            <input type="hidden" id="basePackage" th:value="${project.ms != null ? project.ms.basePackage : ''}"/>
            <input type="hidden" id="basePath"    th:value="${project.ms != null ? project.ms.basePath    : ''}"/>
            <input type="hidden" id="javaVersion" th:value="${project.ms != null ? project.ms.javaVersion : project.javaVersion}"/>
            <input type="hidden" id="ctrlName"    th:value="${ctrl != null ? ctrl.name : ''}"/>
            <input type="hidden" id="epName"      th:value="${ep != null ? ep.name : ''}"/>

            <div class="grid-2">
                <div>
                    <label>Provider</label>
                    <select id="provider">
                        <option value="openai" selected>OpenAI</option>
                        <option value="ollama">Ollama</option>
                        <option value="huggingface">Hugging Face</option>
                    </select>
                </div>
                <div>
                    <label>Model</label>
                    <select id="model"></select>
                </div>
            </div>

            <div style="margin-top:8px">
                <div style="display:flex; align-items:center; gap:8px;">
                    <label style="margin:0;">Prompt (Ø¯Ù„Ø®ÙˆØ§Ù‡)</label>
                    <!-- ğŸ”® Ø¹ØµØ§ÛŒ Ø¬Ø§Ø¯ÙˆÛŒÛŒ: Ø§ØµÙ„Ø§Ø­/ØªÚ©Ù…ÛŒÙ„ Ù¾Ø±Ø§Ù…Ù¾Øª Ø¨Ù‡ ØµÙˆØ±Øª Ø§Ø®ØªÛŒØ§Ø±ÛŒ -->
                    <button type="button" class="btn" title="Ø§ØµÙ„Ø§Ø­/ØªÚ©Ù…ÛŒÙ„ Ù¾Ø±Ø§Ù…Ù¾Øª"
                            onclick="refinePrompt()" style="padding:4px 8px; display:flex; gap:6px; align-items:center;">
                        <span>Ø§ØµÙ„Ø§Ø­ Ù¾Ø±Ø§Ù…Ù¾Øª</span>
                        <span style="font-size:18px;">ğŸª„</span>
                    </button>
                </div>
                <textarea id="prompt" rows="6" placeholder="Ø§Ú¯Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ù…ØªÙ† Ù¾Ø±Ø§Ù…Ù¾Øª Ø±Ø§ Ø¯Ø³ØªÛŒ Ø¨Ø¯Ù‡ÛŒØ¯ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."></textarea>
            </div>

            <div class="actions" style="justify-content:flex-end">
                <button id="btnGen" type="submit" class="btn">Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ (Dry-run)</button>
                <button id="btnCommit" type="button" class="btn btn-primary" onclick="doCommit()"
                        th:text="${mode == 'REFINE' ? 'Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ Ø±ÙˆÛŒ Ù‡Ù…ÛŒÙ† Ø§Ù†Ø¯Ù¾ÙˆÛŒÙ†Øª' : 'Ø«Ø¨Øª Ø¨Ù‡â€ŒØ¹Ù†ÙˆØ§Ù† Ø§Ù†Ø¯Ù¾ÙˆÛŒÙ†Øª'}">
                    Ø«Ø¨Øª
                </button>
            </div>

            <div id="aiStatus" class="muted" style="margin-top:8px; display:none;"></div>
        </form>

        <h4 style="margin-top:12px">Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§</h4>
        <pre id="raw" class="muted" style="white-space:pre-wrap"></pre>
        <div id="files"></div>
    </div>

    <!-- ğŸ§© Modal Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Preflight -->
    <div id="preflight-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:1000;">
        <div style="max-width:520px; margin:60px auto; background:#0b1220; color:#e2e8f0; border:1px solid #334155; border-radius:12px; padding:16px;">
            <div style="display:flex; align-items:center; justify-content:space-between;">
                <h4 style="margin:0;">ØªÚ©Ù…ÛŒÙ„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù„Ø§Ø²Ù… Ù‚Ø¨Ù„ Ø§Ø² ØªÙˆÙ„ÛŒØ¯ (Preflight)</h4>
                <button id="preflight-close" class="btn" type="button">âœ–</button>
            </div>
            <form id="preflight-form" style="margin-top:12px;">
                <div id="preflight-questions"></div>
                <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
                    <button id="preflight-cancel" type="button" class="btn">Ø§Ù†ØµØ±Ø§Ù</button>
                    <button type="submit" class="btn btn-primary">Ø«Ø¨Øª Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§</button>
                </div>
            </form>
        </div>
    </div>

    <script th:inline="javascript">
        // --- state
        window.generated ??= null;
        let __aiBusy = false;

        async function fillModelsForProvider(){
            const prov  = document.getElementById('provider').value;
            const model = document.getElementById('model');
            model.innerHTML = '';
            try{
                const r = await fetch(`/api/ai/meta/models?provider=${encodeURIComponent(prov)}`);
                const arr = await r.json();
                (arr||[]).forEach(m=>{
                    const opt = document.createElement('option');
                    opt.value = m; opt.textContent = m;
                    model.appendChild(opt);
                });
            }catch(_){}
        }
        document.getElementById('provider').addEventListener('change', fillModelsForProvider);
        fillModelsForProvider();

        function setBusy(isBusy, msg=''){
            __aiBusy = !!isBusy;
            const btnGen = document.getElementById('btnGen');
            const status = document.getElementById('aiStatus');
            if (btnGen) btnGen.disabled = isBusy;
            if (status){
                status.style.display = isBusy ? 'block' : 'none';
                status.textContent = msg || '';
            }
        }

        function renderFiles(files){
            const c = document.getElementById('files');
            c.innerHTML = '';
            if (!files || !files.length){
                c.innerHTML = '<div class="muted">ÙØ§ÛŒÙ„ÛŒ Ø¨Ø§Ø²Ú¯Ø´ØªÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</div>';
                return;
            }
            files.forEach(f => {
                if (!f || !f.path) return;
                const pre = document.createElement('pre');
                pre.style.whiteSpace = 'pre-wrap';
                pre.style.direction  = 'ltr';
                pre.textContent = `# ${f.path}\n\n${f.content || ''}`;
                c.appendChild(pre);
            });
        }

        function getIdsForAI() {
            const pid  = document.getElementById('projectId')?.value || '';
            const ctrl = document.getElementById('ctrlName')?.value
                || document.querySelector('.tag[data-ctrl-name]')?.getAttribute('data-ctrl-name')
                || '';
            const ep   = document.getElementById('epName')?.value
                || document.getElementById('endpointSelect')?.value
                || document.getElementById('endpoint')?.value
                || '';
            return { pid, ctrl, ep };
        }

        // =========================
        //    REFINE PROMPT (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
        // =========================
        function openPreflightModal(questions){
            const modal = document.getElementById('preflight-modal');
            const host  = document.getElementById('preflight-questions');
            const btnX  = document.getElementById('preflight-close');
            const btnC  = document.getElementById('preflight-cancel');
            const form  = document.getElementById('preflight-form');

            host.innerHTML = '';
            (questions||[]).forEach(q=>{
                const wrap = document.createElement('div');
                wrap.style.marginBottom = '10px';

                const lab = document.createElement('label');
                lab.textContent = q.label || q.key;
                lab.style.display = 'block';
                lab.style.marginBottom = '4px';
                wrap.appendChild(lab);

                let input;
                if (q.type === 'select' && Array.isArray(q.options)) {
                    input = document.createElement('select');
                    q.options.forEach(opt=>{
                        const o = document.createElement('option');
                        o.value = opt; o.textContent = opt;
                        input.appendChild(o);
                    });
                } else {
                    input = document.createElement('input');
                    input.type = 'text';
                    if (q.placeholder) input.placeholder = q.placeholder;
                }
                input.name = q.key;
                input.required = !!q.required;
                input.style.width = '100%';
                input.style.padding = '8px';
                input.style.borderRadius = '8px';
                input.style.border = '1px solid #334155';
                input.style.background = '#0b1220';
                input.style.color = '#e2e8f0';
                wrap.appendChild(input);

                host.appendChild(wrap);
            });

            const hide = ()=>{ modal.style.display='none'; };
            btnX.onclick = hide;
            btnC.onclick = hide;

            form.onsubmit = async (ev)=>{
                ev.preventDefault();
                const fd = new FormData(form);
                const answers = {};
                (questions||[]).forEach(q=> answers[q.key] = fd.get(q.key) || null);
                hide();

                // ÛŒÚ© Ø¨Ø§Ø± Ø¯ÛŒÚ¯Ø± preflight Ø±Ø§ Ø¨Ø§ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ ØµØ¯Ø§ Ø¨Ø²Ù†
                await refinePrompt(answers);
            };

            modal.style.display = 'block';
        }

        async function refinePrompt(extraVars){
            if (__aiBusy) return;
            const { pid, ctrl, ep } = getIdsForAI();
            if (!pid || !ctrl || !ep){
                alert('Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø§Ù†Ø¯Ù¾ÙˆÛŒÙ†Øª Ø§Ø² Ø¨Ø§Ù„Ø§ÛŒ ØµÙØ­Ù‡ Ø§Ù†ØªØ®Ø§Ø¨/Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯.');
                return;
            }
            setBusy(true, 'Ø¯Ø± Ø­Ø§Ù„ Ø§ØµÙ„Ø§Ø­ Ù¾Ø±Ø§Ù…Ù¾Øª...');

            const provider = document.getElementById('provider')?.value;
            const model    = document.getElementById('model')?.value;
            const basePkg  = document.getElementById('basePackage')?.value || null;
            const basePath = document.getElementById('basePath')?.value || null;
            const jv       = Number(document.getElementById('javaVersion')?.value) || 21;
            const promptEl = document.getElementById('prompt');

            // ğŸ”§ Ù†ÙØ±Ù…â€ŒØ³Ø§Ø²ÛŒ Ú©Ù„ÛŒØ¯Ù‡Ø§ Ø¨Ù‡ Ù†Ø§Ù…â€ŒÙ‡Ø§ÛŒ DTO
            const norm = extraVars || {};
            const normalized = {
                // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ Ù…ÙˆØ¯Ø§Ù„ Ø¬ÙˆØ§Ø¨ Ø¯Ø§Ø¯Ù‡ØŒ ÛŒØ¹Ù†ÛŒ external Ù„Ø§Ø²Ù… Ø§Ø³Øª
                needsExternal: norm.needsExternal ?? true,
                needsDb:       norm.needsDb ?? undefined,

                externalBaseUrl:      norm.externalBaseUrl      ?? norm['external.baseUrl']      ?? norm.baseUrl      ?? null,
                externalPathTemplate: norm.externalPathTemplate ?? norm['external.pathTemplate'] ?? norm.pathTemplate ?? null,
                externalHttpMethod:   norm.externalHttpMethod   ?? norm['external.method']       ?? norm.httpMethod   ?? null,
                externalAuthType:     norm.externalAuthType     ?? norm['external.authType']     ?? norm.authType     ?? null,

                timeoutMs:        norm.timeoutMs        != null ? Number(norm.timeoutMs)        : undefined,
                retryMaxAttempts: norm.retryMaxAttempts != null ? Number(norm.retryMaxAttempts) : undefined,
                retryBackoffMs:   norm.retryBackoffMs   != null ? Number(norm.retryBackoffMs)   : undefined
            };

            const payload = {
                projectId: pid, provider, model,
                prompt: (promptEl?.value || '').trim() || null,
                basePackage: basePkg, basePath, javaVersion: jv,
                controllerName: ctrl, endpointName: ep,
                // Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ Ù†ÙØ±Ù…â€ŒØ³Ø§Ø²ÛŒâ€ŒØ´Ø¯Ù‡
                ...normalized
            };

            try{
                const r = await fetch('/api/ai/preflight', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify(payload)
                });

                if (r.status === 422){
                    const data = await r.json().catch(()=> ({}));
                    if (data?.questions?.length) {
                        openPreflightModal(data.questions);
                    } else {
                        alert(data?.error || 'Preflight needs more inputs.');
                    }
                    return;
                }

                const data = await r.json().catch(()=> ({}));
                if (!data?.ok){
                    alert(data?.error || 'Preflight failed.');
                    return;
                }

                if (data.prompt && promptEl) {
                    promptEl.value = data.prompt; // Ù¾Ø±Ø§Ù…Ù¾Øª Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ø´Ø¯Ù‡
                }
            }catch(err){
                alert('Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡/Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø± preflight: ' + (err?.message || err));
            }finally{
                setBusy(false);
            }
        }

        // =========================
        //    GENERATE (ÙÙ‚Ø· ØªÙˆÙ„ÛŒØ¯)
        // =========================
        window.aiGenerate = async function(payload){
            const rawPre  = document.getElementById('raw');
            const filesDiv= document.getElementById('files');
            if (rawPre) rawPre.textContent = '';
            if (filesDiv) filesDiv.innerHTML = '';

            try{
                const r = await fetch('/api/ai/generate', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify(payload)
                });

                let data; const ct = r.headers.get('content-type') || '';
                if (ct.includes('application/json')) data = await r.json();
                else data = { raw: await r.text() };

                if (!r.ok){
                    window.generated = null;
                    if (rawPre) rawPre.textContent = data?.error || 'âŒ Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯';
                    return false;
                }

                const files = Array.isArray(data.files) ? data.files : [];
                window.generated = { raw: data.raw || '', files };

                if (rawPre) rawPre.textContent = window.generated.raw || '';
                if (typeof renderFiles === 'function') renderFiles(files);

                // Ø°Ø®ÛŒØ±Ù‡ RAW (best-effort)
                try {
                    const { pid, ctrl, ep } = getIdsForAI();
                    const token  = document.querySelector('meta[name="_csrf"]')?.content;
                    const header = document.querySelector('meta[name="_csrf_header"]')?.content;
                    const headers = {'Content-Type':'application/json'}; if (token && header) headers[header]=token;
                    await fetch(`/wizard/${encodeURIComponent(pid)}/controllers/${encodeURIComponent(ctrl)}/endpoints/${encodeURIComponent(ep)}/ai/raw`, {
                        method:'POST', headers, body: JSON.stringify({ raw: window.generated.raw || '' })
                    });
                } catch(_){}

            } catch (err){
                window.generated = null;
                const rawPre  = document.getElementById('raw');
                if (rawPre) rawPre.textContent = 'âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡/Ù¾Ø±Ø¯Ø§Ø²Ø´: ' + (err?.message || err);
            } finally {
                setBusy(false);
            }
            return false;
        };

        async function doGenerate(e){
            if (e) e.preventDefault();
            if (__aiBusy) return false;

            const { pid, ctrl, ep } = getIdsForAI();
            if (!pid || !ctrl || !ep){
                alert('Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø§Ù†Ø¯Ù¾ÙˆÛŒÙ†Øª Ø§Ø² Ø¨Ø§Ù„Ø§ÛŒ ØµÙØ­Ù‡ Ø§Ù†ØªØ®Ø§Ø¨/Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯.');
                return false;
            }

            const provider = document.getElementById('provider')?.value;
            const model    = document.getElementById('model')?.value;
            const basePkg  = document.getElementById('basePackage')?.value || null;
            const basePath = document.getElementById('basePath')?.value || null;
            const jv       = Number(document.getElementById('javaVersion')?.value) || 21;

            const promptText = (document.getElementById('prompt')?.value || '').trim();
            const payload = {
                projectId: pid, provider, model,
                prompt: promptText || null,
                basePackage: basePkg, basePath,
                javaVersion: jv,
                controllerName: ctrl, endpointName: ep
            };

            setBusy(true, 'Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯ Ú©Ø¯ ØªÙˆØ³Ø· AI...');
            return window.aiGenerate(payload);
        }

        async function doCommit(){
            const pid  = document.getElementById('projectId')?.value;
            const ctrl = document.getElementById('ctrlName')?.value;
            const ep   = document.getElementById('epName')?.value
                || document.getElementById('endpointSelect')?.value;

            if (!pid || !ctrl || !ep){
                alert('Ú©Ù†ØªØ±Ù„Ø±/Ø§Ù†Ø¯Ù¾ÙˆÛŒÙ†Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.');
                return;
            }

            const promptText = (document.getElementById('prompt')?.value || '').trim();

            const token  = document.querySelector('meta[name="_csrf"]')?.content;
            const header = document.querySelector('meta[name="_csrf_header"]')?.content;
            const headersJSON = {'Content-Type':'application/json'};
            const headers = {'X-Requested-With':'fetch'};
            if (token && header){ headers[header] = token; headersJSON[header] = token; }

            setBusy(true, 'Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ AI Ø±ÙˆÛŒ Ø§Ù†Ø¯Ù¾ÙˆÛŒÙ†Øª...');
            try{
                if (promptText){
                    try{
                        await fetch(
                            `/wizard/${encodeURIComponent(pid)}/controllers/${encodeURIComponent(ctrl)}/endpoints/${encodeURIComponent(ep)}/prompt`,
                            { method:'POST', headers: headersJSON, body: JSON.stringify({ prompt: promptText }) }
                        );
                    }catch(_){}
                }

                if (window.generated?.raw){
                    try{
                        await fetch(
                            `/wizard/${encodeURIComponent(pid)}/controllers/${encodeURIComponent(ctrl)}/endpoints/${encodeURIComponent(ep)}/ai/raw`,
                            { method:'POST', headers: headersJSON, body: JSON.stringify({ raw: window.generated.raw }) }
                        );
                    }catch(_){}
                }

                const url = `/wizard/${encodeURIComponent(pid)}/controllers/${encodeURIComponent(ctrl)}/endpoints/${encodeURIComponent(ep)}/ai/commit?clearStash=true`;
                const r = await fetch(url, { method:'POST', headers });
                const data = await r.json().catch(()=> ({}));
                if (!r.ok || !data.ok){
                    alert(data.message || 'Ø«Ø¨Øª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯.');
                    return;
                }

                location.href = `/wizard/${encodeURIComponent(pid)}/controllers?ctrl=${encodeURIComponent(ctrl)}&ep=${encodeURIComponent(ep)}`;

            } catch(err){
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª: ' + (err?.message || err));
            } finally {
                setBusy(false);
            }
        }
    </script>
</div>
